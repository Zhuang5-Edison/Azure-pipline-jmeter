
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  JMETER_VERSION: '5.6.3'
  TESTPLAN: 'mms.uat.exyte.net.jmx'
  RESULTS_DIR: 'results'
  REPORT_DIR: 'report'

steps:
- script: |
    set -eux
    wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$(JMETER_VERSION).tgz
    tar -xf apache-jmeter-$(JMETER_VERSION).tgz
  displayName: 'Install Apache JMeter'

- script: |
    set -eux
    mkdir -p $(RESULTS_DIR) $(REPORT_DIR)
    apache-jmeter-$(JMETER_VERSION)/bin/jmeter \
      -n \
      -t $(TESTPLAN) \
      -l $(RESULTS_DIR)/results.jtl \
      -j $(RESULTS_DIR)/jmeter.log \
      -Jjmeter.save.saveservice.output_format=csv \
      -Jjmeter.reportgenerator.overall_granularity=1000 \
      -e -o $(REPORT_DIR)
  displayName: 'Run JMeter and generate HTML report'

- publish: $(System.DefaultWorkingDirectory)/results
  artifact: jmeter-results
  displayName: 'Publish JMeter raw results (.jtl/.log)'

- task: PublishPipelineArtifact@1
  displayName: 'Publish JMeter HTML report'
  inputs:
    targetPath: '$(REPORT_DIR)'
    artifact: 'jmeter-report'
